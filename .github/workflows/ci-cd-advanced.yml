name: ğŸš€ CI/CD Advanced Pipeline

on:
  push:
    branches: [ main, production, develop ]
    tags: [ 'v*' ]
  pull_request:
    branches: [ main, production ]
  workflow_dispatch:
    inputs:
      force_rebuild:
        description: 'Force rebuild without cache'
        required: false
        default: false
        type: boolean
      environment:
        description: 'Target environment'
        required: false
        default: 'staging'
        type: choice
        options:
          - staging
          - production

permissions:
  contents: write
  packages: write
  pull-requests: write
  issues: write
  security-events: write

env:
  # Docker Hub
  DOCKER_REGISTRY: docker.io
  DOCKER_BACKEND_IMAGE: ${{ secrets.DOCKERHUB_USERNAME }}/cochin-project-manager-backend
  DOCKER_FRONTEND_IMAGE: ${{ secrets.DOCKERHUB_USERNAME }}/cochin-project-manager-frontend
  
  # GitHub Container Registry
  GHCR_REGISTRY: ghcr.io
  GHCR_BACKEND_IMAGE: ghcr.io/${{ github.repository }}/backend
  GHCR_FRONTEND_IMAGE: ghcr.io/${{ github.repository }}/frontend

jobs:
  # =====================================================
  # Job 1: Tests et validations
  # =====================================================
  tests:
    name: ğŸ§ª Tests & Quality Checks
    runs-on: ubuntu-latest
    outputs:
      backend-changed: ${{ steps.changes.outputs.backend == 'true' || startsWith(github.ref, 'refs/tags/') || github.ref == 'refs/heads/main' }}
      frontend-changed: ${{ steps.changes.outputs.frontend == 'true' || startsWith(github.ref, 'refs/tags/') || github.ref == 'refs/heads/main' }}
    
    steps:
    - name: ğŸ“¥ Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0

    - name: ğŸ” Detect changes
      uses: dorny/paths-filter@v2
      id: changes
      with:
        filters: |
          backend:
            - 'backend/**'
            - 'Dockerfile.backend'
            - 'requirements.txt'
          frontend:
            - 'frontend/**'
            - 'Dockerfile.frontend'
            - 'package.json'
            - 'package-lock.json'

    - name: ğŸ Setup Python
      if: steps.changes.outputs.backend == 'true' || startsWith(github.ref, 'refs/tags/') || github.ref == 'refs/heads/main'
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'
        cache: 'pip'

    - name: ğŸ“¦ Install Python dependencies
      if: steps.changes.outputs.backend == 'true' || startsWith(github.ref, 'refs/tags/') || github.ref == 'refs/heads/main'
      working-directory: backend
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        pip install flake8 safety bandit pytest pytest-django

    - name: ğŸ” Python code quality check
      if: steps.changes.outputs.backend == 'true' || startsWith(github.ref, 'refs/tags/') || github.ref == 'refs/heads/main'
      working-directory: backend
      run: |
        echo "ğŸ” Running Python linting..."
        flake8 . --count --select=E9,F63,F7,F82 --show-source --statistics
        flake8 . --count --exit-zero --max-complexity=10 --max-line-length=127 --statistics

    - name: ğŸ§ª Python tests
      if: steps.changes.outputs.backend == 'true' || startsWith(github.ref, 'refs/tags/') || github.ref == 'refs/heads/main'
      working-directory: backend
      run: |
        echo "ğŸ§ª Running Python tests..."
        python -m pytest tests/ -v --tb=short || true

    - name: ğŸ›¡ï¸ Python security check
      if: steps.changes.outputs.backend == 'true' || startsWith(github.ref, 'refs/tags/') || github.ref == 'refs/heads/main'
      working-directory: backend
      run: |
        echo "ğŸ›¡ï¸ Checking Python dependencies for security issues..."
        safety scan --output json --save-json safety-report.json || echo "âš ï¸ Vulnerabilities found, check safety-report.json"
        echo "ğŸ”’ Running security analysis on code..."
        bandit -r . -f json -o bandit-report.json || true
        echo "ğŸ“Š Security scan completed. Reports saved as safety-report.json and bandit-report.json"

    - name: ğŸŸ¢ Setup Node.js
      if: steps.changes.outputs.frontend == 'true' || startsWith(github.ref, 'refs/tags/') || github.ref == 'refs/heads/main'
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        cache: 'npm'
        cache-dependency-path: 'frontend/package-lock.json'

    - name: ğŸ“¦ Install Node.js dependencies
      if: steps.changes.outputs.frontend == 'true' || startsWith(github.ref, 'refs/tags/') || github.ref == 'refs/heads/main'
      working-directory: frontend
      run: npm install --no-package-lock

    - name: ğŸ” Frontend code quality check
      if: steps.changes.outputs.frontend == 'true' || startsWith(github.ref, 'refs/tags/') || github.ref == 'refs/heads/main'
      working-directory: frontend
      run: |
        echo "ğŸ” Running ESLint..."
        npm run lint -- --max-warnings 10

    - name: ğŸ§ª Frontend tests
      if: steps.changes.outputs.frontend == 'true' || startsWith(github.ref, 'refs/tags/') || github.ref == 'refs/heads/main'
      working-directory: frontend
      run: |
        echo "ğŸ§ª Running frontend tests..."
        # npm run test || true  # Uncomment when tests are available

    - name: ğŸ—ï¸ Frontend build test
      if: steps.changes.outputs.frontend == 'true' || startsWith(github.ref, 'refs/tags/') || github.ref == 'refs/heads/main'
      working-directory: frontend
      run: |
        echo "ğŸ—ï¸ Testing frontend build..."
        npm install --no-package-lock
        npm run build

  # =====================================================
  # Job 2: Build et push des images Docker (en parallÃ¨le)
  # =====================================================
  build-backend:
    name: ğŸ³ Build Backend Image
    runs-on: ubuntu-latest
    needs: tests
    if: always() && needs.tests.result == 'success' && (needs.tests.outputs.backend-changed == 'true' || github.event_name == 'workflow_dispatch' || startsWith(github.ref, 'refs/tags/'))
    outputs:
      image-digest: ${{ steps.build.outputs.digest }}
      image-version: ${{ steps.meta.outputs.version }}
    
    steps:
    - name: ğŸ“¥ Checkout code
      uses: actions/checkout@v4

    - name: ğŸ”§ Set up Docker Buildx
      uses: docker/setup-buildx-action@v3

    - name: ğŸ” Log in to Docker Hub
      if: github.event_name != 'pull_request'
      uses: docker/login-action@v3
      with:
        registry: ${{ env.DOCKER_REGISTRY }}
        username: ${{ secrets.DOCKERHUB_USERNAME }}
        password: ${{ secrets.DOCKERHUB_TOKEN }}

    - name: ğŸ“¦ Log in to GitHub Container Registry
      if: github.event_name != 'pull_request'
      uses: docker/login-action@v3
      with:
        registry: ${{ env.GHCR_REGISTRY }}
        username: ${{ github.actor }}
        password: ${{ secrets.GITHUB_TOKEN }}

    - name: ğŸ·ï¸ Extract metadata
      id: meta
      uses: docker/metadata-action@v5
      with:
        images: |
          ${{ env.DOCKER_BACKEND_IMAGE }}
          ${{ env.GHCR_BACKEND_IMAGE }}
        tags: |
          # Pour les tags de version (v1.0.1) -> latest + version spÃ©cifique
          type=semver,pattern={{version}}
          type=raw,value=latest,enable=${{ startsWith(github.ref, 'refs/tags/v') }}
          # Pour la branche main -> dev seulement
          type=raw,value=dev,enable={{is_default_branch}}
          # Pour les PRs -> tag PR
          type=ref,event=pr
          # Pour debug -> SHA
          type=sha,prefix=sha-,enable=${{ github.event_name == 'workflow_dispatch' }}
        labels: |
          org.opencontainers.image.title=Cochin Backend
          org.opencontainers.image.description=Backend API for Cochin Project Manager
          org.opencontainers.image.vendor=Cochin Team
          org.opencontainers.image.source=https://github.com/${{ github.repository }}
          org.opencontainers.image.url=https://github.com/${{ github.repository }}

    - name: ğŸ—ï¸ Build and push to both registries
      id: build
      uses: docker/build-push-action@v5
      with:
        context: .
        file: ./Dockerfile.backend
        push: ${{ github.event_name != 'pull_request' }}
        tags: ${{ steps.meta.outputs.tags }}
        labels: ${{ steps.meta.outputs.labels }}
        cache-from: type=gha,scope=backend
        cache-to: type=gha,mode=max,scope=backend
        no-cache: ${{ github.event.inputs.force_rebuild == 'true' }}

  build-frontend:
    name: ğŸ¨ Build Frontend Image  
    runs-on: ubuntu-latest
    needs: tests
    if: always() && needs.tests.result == 'success' && (needs.tests.outputs.frontend-changed == 'true' || github.event_name == 'workflow_dispatch' || startsWith(github.ref, 'refs/tags/'))
    outputs:
      image-digest: ${{ steps.build.outputs.digest }}
      image-version: ${{ steps.meta.outputs.version }}
    
    steps:
    - name: ğŸ“¥ Checkout code
      uses: actions/checkout@v4

    - name: ğŸ”§ Set up Docker Buildx
      uses: docker/setup-buildx-action@v3

    - name: ğŸ” Log in to Docker Hub
      if: github.event_name != 'pull_request'
      uses: docker/login-action@v3
      with:
        registry: ${{ env.DOCKER_REGISTRY }}
        username: ${{ secrets.DOCKERHUB_USERNAME }}
        password: ${{ secrets.DOCKERHUB_TOKEN }}

    - name: ğŸ“¦ Log in to GitHub Container Registry
      if: github.event_name != 'pull_request'
      uses: docker/login-action@v3
      with:
        registry: ${{ env.GHCR_REGISTRY }}
        username: ${{ github.actor }}
        password: ${{ secrets.GITHUB_TOKEN }}

    - name: ğŸ·ï¸ Extract metadata
      id: meta
      uses: docker/metadata-action@v5
      with:
        images: |
          ${{ env.DOCKER_FRONTEND_IMAGE }}
          ${{ env.GHCR_FRONTEND_IMAGE }}
        tags: |
          # Pour les tags de version (v1.0.1) -> latest + version spÃ©cifique
          type=semver,pattern={{version}}
          type=raw,value=latest,enable=${{ startsWith(github.ref, 'refs/tags/v') }}
          # Pour la branche main -> dev seulement
          type=raw,value=dev,enable={{is_default_branch}}
          # Pour les PRs -> tag PR
          type=ref,event=pr
          # Pour debug -> SHA
          type=sha,prefix=sha-,enable=${{ github.event_name == 'workflow_dispatch' }}
        labels: |
          org.opencontainers.image.title=Cochin Frontend
          org.opencontainers.image.description=Frontend UI for Cochin Project Manager
          org.opencontainers.image.vendor=Cochin Team
          org.opencontainers.image.source=https://github.com/${{ github.repository }}
          org.opencontainers.image.url=https://github.com/${{ github.repository }}

    - name: ğŸ—ï¸ Build and push to both registries
      id: build
      uses: docker/build-push-action@v5
      with:
        context: .
        file: ./Dockerfile.frontend
        push: ${{ github.event_name != 'pull_request' }}
        tags: ${{ steps.meta.outputs.tags }}
        labels: ${{ steps.meta.outputs.labels }}
        cache-from: type=gha,scope=frontend
        cache-to: type=gha,mode=max,scope=frontend
        no-cache: ${{ github.event.inputs.force_rebuild == 'true' }}

  # =====================================================
  # Job 3: Scan de sÃ©curitÃ© des images
  # =====================================================
  security-scan:
    name: ğŸ›¡ï¸ Security Scan
    runs-on: ubuntu-latest
    needs: [build-backend, build-frontend]
    if: always() && (needs.build-backend.result == 'success' || needs.build-frontend.result == 'success')
    
    steps:
    - name: ğŸ“¥ Checkout code
      uses: actions/checkout@v4
      
    - name: ğŸ” Run Trivy vulnerability scanner (Backend)
      if: needs.build-backend.result == 'success'
      uses: aquasecurity/trivy-action@master
      with:
        image-ref: ${{ env.DOCKER_BACKEND_IMAGE }}:latest
        format: 'sarif'
        output: 'backend-trivy-results.sarif'

    - name: ğŸ” Run Trivy vulnerability scanner (Frontend)
      if: needs.build-frontend.result == 'success'
      uses: aquasecurity/trivy-action@master
      with:
        image-ref: ${{ env.DOCKER_FRONTEND_IMAGE }}:latest
        format: 'sarif'
        output: 'frontend-trivy-results.sarif'

    - name: ğŸ“¤ Upload Backend Trivy scan results to GitHub Security tab
      uses: github/codeql-action/upload-sarif@v3
      if: always() && needs.build-backend.result == 'success'
      with:
        sarif_file: 'backend-trivy-results.sarif'
        category: 'trivy-backend'

    - name: ğŸ“¤ Upload Frontend Trivy scan results to GitHub Security tab
      uses: github/codeql-action/upload-sarif@v3
      if: always() && needs.build-frontend.result == 'success'
      with:
        sarif_file: 'frontend-trivy-results.sarif'
        category: 'trivy-frontend'

  # =====================================================
  # Job 4: CrÃ©er une release GitHub (pour les tags)
  # =====================================================
  create-release:
    name: ğŸ·ï¸ Create GitHub Release
    runs-on: ubuntu-latest
    needs: [build-backend, build-frontend, security-scan]
    if: startsWith(github.ref, 'refs/tags/v') && (needs.build-backend.result == 'success' || needs.build-frontend.result == 'success')
    
    steps:
    - name: ğŸ“¥ Checkout code
      uses: actions/checkout@v4

    - name: ğŸ·ï¸ Create Release
      uses: actions/create-release@v1
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      with:
        tag_name: ${{ github.ref_name }}
        release_name: Release ${{ github.ref_name }}
        body: |
          ## ğŸš€ Release ${{ github.ref_name }}
          
          ### ğŸ“¦ Images Docker publiÃ©es:
          
          #### Docker Hub:
          ${{ needs.build-backend.result == 'success' && format('- **Backend**: `{0}:{1}`', env.DOCKER_BACKEND_IMAGE, needs.build-backend.outputs.image-version) || '' }}
          ${{ needs.build-frontend.result == 'success' && format('- **Frontend**: `{0}:{1}`', env.DOCKER_FRONTEND_IMAGE, needs.build-frontend.outputs.image-version) || '' }}
          
          #### GitHub Container Registry:
          ${{ needs.build-backend.result == 'success' && format('- **Backend**: `{0}:{1}`', env.GHCR_BACKEND_IMAGE, needs.build-backend.outputs.image-version) || '' }}
          ${{ needs.build-frontend.result == 'success' && format('- **Frontend**: `{0}:{1}`', env.GHCR_FRONTEND_IMAGE, needs.build-frontend.outputs.image-version) || '' }}
          
          ### ğŸš€ Commande de dÃ©ploiement rapide:
          ```bash
          DOCKERHUB_USERNAME=${{ secrets.DOCKERHUB_USERNAME }} BACKEND_TAG=${{ github.ref_name }} FRONTEND_TAG=${{ github.ref_name }} ./deploy-prod.sh
          ```
          
          ### ğŸ”„ Commande de mise Ã  jour:
          ```bash
          DOCKERHUB_USERNAME=${{ secrets.DOCKERHUB_USERNAME }} ./check-updates.sh
          ```
        draft: false
        prerelease: contains(github.ref_name, 'rc') || contains(github.ref_name, 'beta') || contains(github.ref_name, 'alpha')

  # =====================================================
  # Job 5: Notifications et rÃ©sumÃ© final
  # =====================================================
  notify-and-summary:
    name: ğŸ“¢ Notifications & Summary
    runs-on: ubuntu-latest
    needs: [tests, build-backend, build-frontend, security-scan]
    if: always() && github.event_name != 'pull_request'
    
    steps:
    - name: ğŸ“¥ Checkout code
      uses: actions/checkout@v4

    - name: ğŸ“Š Generate deployment summary
      run: |
        echo "## ğŸš€ Pipeline CI/CD - RÃ©sumÃ© d'exÃ©cution" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### ğŸ“Š Statut des jobs:" >> $GITHUB_STEP_SUMMARY
        echo "- **Tests**: ${{ needs.tests.result == 'success' && 'âœ… RÃ©ussi' || 'âŒ Ã‰chec' }}" >> $GITHUB_STEP_SUMMARY
        echo "- **Build Backend**: ${{ needs.build-backend.result == 'success' && 'âœ… RÃ©ussi' || needs.build-backend.result == 'skipped' && 'â­ï¸ IgnorÃ©' || 'âŒ Ã‰chec' }}" >> $GITHUB_STEP_SUMMARY
        echo "- **Build Frontend**: ${{ needs.build-frontend.result == 'success' && 'âœ… RÃ©ussi' || needs.build-frontend.result == 'skipped' && 'â­ï¸ IgnorÃ©' || 'âŒ Ã‰chec' }}" >> $GITHUB_STEP_SUMMARY
        echo "- **Scan SÃ©curitÃ©**: ${{ needs.security-scan.result == 'success' && 'âœ… RÃ©ussi' || needs.security-scan.result == 'skipped' && 'â­ï¸ IgnorÃ©' || 'âŒ Ã‰chec' }}" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        
        if [[ "${{ needs.build-backend.result }}" == "success" || "${{ needs.build-frontend.result }}" == "success" ]]; then
          echo "### ğŸ“¦ Images publiÃ©es:" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "#### Docker Hub:" >> $GITHUB_STEP_SUMMARY
          [[ "${{ needs.build-backend.result }}" == "success" ]] && echo "- **Backend**: \`${{ env.DOCKER_BACKEND_IMAGE }}:${{ needs.build-backend.outputs.image-version }}\`" >> $GITHUB_STEP_SUMMARY
          [[ "${{ needs.build-frontend.result }}" == "success" ]] && echo "- **Frontend**: \`${{ env.DOCKER_FRONTEND_IMAGE }}:${{ needs.build-frontend.outputs.image-version }}\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "#### GitHub Container Registry:" >> $GITHUB_STEP_SUMMARY
          [[ "${{ needs.build-backend.result }}" == "success" ]] && echo "- **Backend**: \`${{ env.GHCR_BACKEND_IMAGE }}:${{ needs.build-backend.outputs.image-version }}\`" >> $GITHUB_STEP_SUMMARY
          [[ "${{ needs.build-frontend.result }}" == "success" ]] && echo "- **Frontend**: \`${{ env.GHCR_FRONTEND_IMAGE }}:${{ needs.build-frontend.outputs.image-version }}\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ğŸš€ Commandes de dÃ©ploiement:" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`bash" >> $GITHUB_STEP_SUMMARY
          echo "# DÃ©ploiement rapide" >> $GITHUB_STEP_SUMMARY
          echo "DOCKERHUB_USERNAME=${{ secrets.DOCKERHUB_USERNAME }} ./deploy-prod.sh" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "# VÃ©rification des mises Ã  jour" >> $GITHUB_STEP_SUMMARY
          echo "DOCKERHUB_USERNAME=${{ secrets.DOCKERHUB_USERNAME }} ./check-updates.sh" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
        fi

    - name: ğŸ”” Send Discord notification (Success)
      if: needs.tests.result == 'success' && (needs.build-backend.result == 'success' || needs.build-frontend.result == 'success')
      env:
        DISCORD_WEBHOOK_URL: ${{ secrets.DISCORD_WEBHOOK_URL }}
      run: |
        if [ -n "$DISCORD_WEBHOOK_URL" ]; then
          curl -H "Content-Type: application/json" \
            -d '{
              "embeds": [{
                "title": "âœ… CI/CD Pipeline - SuccÃ¨s",
                "description": "Le pipeline CI/CD s est exÃ©cutÃ© avec succÃ¨s !",
                "color": 3066993,
                "fields": [
                  {
                    "name": "ğŸ“¦ Repository",
                    "value": "${{ github.repository }}",
                    "inline": true
                  },
                  {
                    "name": "ğŸŒ¿ Branche",
                    "value": "${{ github.ref_name }}",
                    "inline": true
                  },
                  {
                    "name": "ğŸ‘¤ Auteur",
                    "value": "${{ github.actor }}",
                    "inline": true
                  },
                  {
                    "name": "ğŸ“ Commit",
                    "value": "[${{ github.sha }}](https://github.com/${{ github.repository }}/commit/${{ github.sha }})",
                    "inline": false
                  },
                  {
                    "name": "ğŸš€ Images construites",
                    "value": "${{ needs.build-backend.result == 'success' && 'ğŸ³ Backend' || '' }} ${{ needs.build-frontend.result == 'success' && 'ğŸ¨ Frontend' || '' }}",
                    "inline": false
                  }
                ],
                "timestamp": "'$(date -u +%Y-%m-%dT%H:%M:%S.%3NZ)'",
                "footer": {
                  "text": "Cochin Project Manager CI/CD"
                }
              }]
            }' \
            "$DISCORD_WEBHOOK_URL"
        fi

    - name: ğŸ”” Send Discord notification (Failure)
      if: failure() || needs.tests.result == 'failure' || needs.build-backend.result == 'failure' || needs.build-frontend.result == 'failure'
      env:
        DISCORD_WEBHOOK_URL: ${{ secrets.DISCORD_WEBHOOK_URL }}
      run: |
        if [ -n "$DISCORD_WEBHOOK_URL" ]; then
          curl -H "Content-Type: application/json" \
            -d '{
              "embeds": [{
                "title": "âŒ CI/CD Pipeline - Ã‰chec",
                "description": "Le pipeline CI/CD a Ã©chouÃ© !",
                "color": 15158332,
                "fields": [
                  {
                    "name": "ğŸ“¦ Repository",
                    "value": "${{ github.repository }}",
                    "inline": true
                  },
                  {
                    "name": "ğŸŒ¿ Branche",
                    "value": "${{ github.ref_name }}",
                    "inline": true
                  },
                  {
                    "name": "ğŸ‘¤ Auteur",
                    "value": "${{ github.actor }}",
                    "inline": true
                  },
                  {
                    "name": "ğŸ“ Commit",
                    "value": "[${{ github.sha }}](https://github.com/${{ github.repository }}/commit/${{ github.sha }})",
                    "inline": false
                  },
                  {
                    "name": "ğŸ”— Voir les logs",
                    "value": "[Logs de l action](https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }})",
                    "inline": false
                  }
                ],
                "timestamp": "'$(date -u +%Y-%m-%dT%H:%M:%S.%3NZ)'",
                "footer": {
                  "text": "Cochin Project Manager CI/CD"
                }
              }]
            }' \
            "$DISCORD_WEBHOOK_URL"
        fi 